{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<h2>Nueva Venta</h2>
<form action="{% url 'create-sale' %}" method="post" id="form-container">
  {% csrf_token %}
  {{ form.user|as_crispy_field }}
  {{ form.customer|as_crispy_field }}
  <hr>
  <div class="products-list">
    <h3>Productos</h3>
    {{products.management_form}}
    <div id="empty_form" style="display: none;">
      {% with products.empty_form as emptyform %}
      <div class="form-row" data-form-index="">
        <div class="row">
          <div class="col-4">
            {{ emptyform.product|as_crispy_field }}
          </div>
          <div class="col-4">
            {{ emptyform.price|as_crispy_field }}
          </div>
          <div class="col-4">
            <button id="delete-form" type="button" class="btn btn-secondary remove-form-row" data-form-index="">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
      {% endwith %}
    </div>
    <div class="product-forms">
      {% for productform in products %}
      <div class="form-row" data-form-index="0">
        <div class="row">
          <div class="col-4">
            {{ productform.product|as_crispy_field }}
          </div>
          <div class="col-4">
            {{ productform.price|as_crispy_field }}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <button id="add-form" type="button" class="btn btn-secondary add-form-row">Agregar</button>
  </div>
  <hr>
  <div class="row">
    <div class="col-4">
      {{ form.price|as_crispy_field }}
    </div>
    <div class="col-4">
      {{ form.installments|as_crispy_field }}
    </div>
    <div class="col-4">
      {{ form.installment_amount|as_crispy_field }}
    </div>
  </div>
  <div class="col-6" id="payment-scheme">
    <p class="title">Esquema de Pago:</p>
    <table class="table">
      <tbody>
        <tr id="payment-scheme-row-1" class="payment-scheme-row">
          <th scope="row" id="i"></th>
          <td>cuotas de</td>
          <td id="i_amount"></td>
        </tr>
        <tr id="payment-scheme-row-2" class="payment-scheme-row">
          <th scope="row">1</th>
          <td>cuota de</td>
          <td id="rest_amount"></td>
        </tr>
      </tbody>
    </table>
  </div>
  <input type="submit" value="Guardar Venta" class="btn btn-primary">
</form>
{% endblock %}

{% block extra_js %}
<script>
  // Container
  const productFormsContainer = document.querySelector('.product-forms');
  const addFormButton = document.querySelector('.add-form-row');
  // Form to be cloned
  const emptyForm = document.querySelector('#empty_form .form-row');
  // Total forms number
  const totalFormsInput = document.querySelector("#id_saleproduct_set-TOTAL_FORMS");

  const getDataFormIndex = (target) => {
    // Return the data-form-index attribute value from the first parent which has that attribute setted.
    if (target.dataset.formIndex) {
      return target.dataset.formIndex;
    }
    return getDataFormIndex(target.parentElement);
  };

  const removeForm = (e) => {
    // Manage the form deletion process
    e.preventDefault();

    // Get the form index and remove the form
    const indexFormToDelete = getDataFormIndex(e.target);
    const form = document.querySelector(`.form-row[data-form-index="${indexFormToDelete}"]`);
    form.remove();

    // Update total form input value
    const formIndex = document.querySelectorAll('.form-row').length - 1;
    totalFormsInput.value = formIndex;

    // Update forms index value. Django validate that the forms in the post request have a subsequent value
    // starting from 0, eg: saleproduct_set-0, saleproduct_set-1, saleproduct_set-2, etc.
    const formRow = productFormsContainer.querySelectorAll('.form-row');
    const formRegex = RegExp(`saleproduct_set-(\\d){1}-`, 'g');
    for (var i = 1; i < formRow.length; i++) {
      formRow[i].innerHTML = formRow[i].innerHTML.replace(formRegex, `saleproduct_set-${i}-`);
      formRow[i].dataset.formIndex = i;
      // Update remove button form index attribute or delete will not work anymore
      const removeButton = formRow[i].querySelector('button');
      removeButton.dataset.formIndex = i;
      // Attach the click event listener again because after updating formRow[i].innerHTML, the DOM recreates
      // the node and the event is lost.
      removeButton.addEventListener('click', removeForm);
    }
  };

  addFormButton.addEventListener('click', e => {
    // Manage the form add process
    e.preventDefault();

    // Clone the empty form and update its index
    const newForm = emptyForm.cloneNode(true);
    // Forms are zero-based index
    const formIndex = document.querySelectorAll('.form-row').length - 1;
    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIndex);
    newForm.dataset.formIndex = formIndex;

    // Update total form input value
    totalFormsInput.value = formIndex + 1;

    // Update the index of the form to remove, and attach the click event listener to the remove button
    const removeFormButton = newForm.querySelector('.remove-form-row');
    removeFormButton.dataset.formIndex = formIndex;
    removeFormButton.addEventListener('click', removeForm);

    // Insert the form in the DOM
    productFormsContainer.appendChild(newForm);
  });
</script>
<script>
  //TODO: Please refactor this shit!
  const priceInput = document.getElementById('id_price');
  const installmentsInput = document.getElementById('id_installments');
  const installmentAmountInput = document.getElementById('id_installment_amount');
  const paymentSchemeRow1 = document.getElementById('payment-scheme-row-1');
  const paymentSchemeRow2 = document.getElementById('payment-scheme-row-2');

  const togglePaymentSchemeRow = (row, action) => {
    const th = row.querySelector('th');
    const td = row.querySelectorAll('td');
    if (action == 'hidden') {
      th.style.visibility = 'hidden';
      td[0].style.visibility = 'hidden';
      td[1].style.visibility = 'hidden';
    } else if (action == 'visible') {
      th.style.visibility = 'visible';
      td[0].style.visibility = 'visible';
      td[1].style.visibility = 'visible';
    }
  }

  const updatePaymentSchemeRow = (row, installments, installmentAmount) => {
    const th = row.querySelector('th');
    const td = row.querySelectorAll('td');
    th.innerText = installments;
    td[1].innerText = installmentAmount.toFixed(2);
  }

  priceInput.addEventListener('change', e => {
    installmentsInput.value = '';
    installmentAmountInput.value = '';
    togglePaymentSchemeRow(paymentSchemeRow1, 'hidden');
    togglePaymentSchemeRow(paymentSchemeRow2, 'hidden');
  });

  installmentsInput.addEventListener('change', e => {
    const price = parseFloat(priceInput.value);
    const installments = parseInt(installmentsInput.value);
    const installmentAmount = price / installments;
    installmentAmountInput.value = installmentAmount.toFixed(2);

    updatePaymentSchemeRow(paymentSchemeRow1, installments, installmentAmount);
    togglePaymentSchemeRow(paymentSchemeRow1, 'visible');
    togglePaymentSchemeRow(paymentSchemeRow2, 'hidden');
  });

  installmentAmountInput.addEventListener('change', e => {
    const price = parseFloat(priceInput.value);
    const installmentAmount = parseFloat(installmentAmountInput.value);
    const installments = price / installmentAmount;

    togglePaymentSchemeRow(paymentSchemeRow1, 'visible');
    if (Number.isInteger(installments)) {
      installmentsInput.value = installments;
      updatePaymentSchemeRow(paymentSchemeRow1, installments, installmentAmount);
      togglePaymentSchemeRow(paymentSchemeRow2, 'hidden');
    } else {
      rest = installments - Math.trunc(installments);
      newQuantity = Math.trunc(installments);

      if (rest <= 0.6) {
        newQuantity--;
      }

      installmentsInput.value = newQuantity + 1;
      lastInstallmentAmount = price - (newQuantity * installmentAmount);
      updatePaymentSchemeRow(paymentSchemeRow1, newQuantity, installmentAmount);
      updatePaymentSchemeRow(paymentSchemeRow2, 1, lastInstallmentAmount);
      togglePaymentSchemeRow(paymentSchemeRow2, 'visible');
    }
  });
</script>
{% endblock %}