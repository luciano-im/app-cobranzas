{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
  <h2>Nueva Venta</h2>
  <form action="{% url 'create-sale' %}" method="post">
    {% csrf_token %}
    {{ form.user|as_crispy_field }}
    {{ form.customer|as_crispy_field }}
    {{ form.product|as_crispy_field }}
    <div class="row">
      <div class="col-4">
        {{ form.price|as_crispy_field }}
      </div>
      <div class="col-4">
        {{ form.installments|as_crispy_field }}
      </div>
      <div class="col-4">
        {{ form.installment_amount|as_crispy_field }}
      </div>
    </div>
    <div class="col-6" id="payment-scheme">
      <p class="title">Esquema de Pago:</p>
      <table class="table">
        <tbody>
          <tr id="payment-scheme-row-1" class="payment-scheme-row">
            <th scope="row" id="i"></th>
            <td>cuotas de</td>
            <td id="i_amount"></td>
          </tr>
          <tr id="payment-scheme-row-2" class="payment-scheme-row">
            <th scope="row">1</th>
            <td>cuota de</td>
            <td id="rest_amount"></td>
          </tr>
        </tbody>
      </table>
    </div>
    <input type="submit" value="Guardar Venta" class="btn btn-primary">
  </form>
{% endblock %}

{% block extra_js %}
<script>
  const priceInput = document.getElementById('id_price');
  const installmentsInput = document.getElementById('id_installments');
  const installmentAmountInput = document.getElementById('id_installment_amount');
  const paymentSchemeRow1 = document.getElementById('payment-scheme-row-1');
  const paymentSchemeRow2 = document.getElementById('payment-scheme-row-2');
  //const quantity = document.getElementById('quantity');
  //const i = document.getElementById('i');
  //const iAmount = document.getElementById('i_amount');
  //const restAmount = document.getElementById('rest_amount');

  installmentsInput.addEventListener('keyup', e => {
    const price = parseFloat(priceInput.value);
    const installments = parseInt(installmentsInput.value);
    const installmentAmount = price / installments;
    installmentAmountInput.value = installmentAmount;

    const th = paymentSchemeRow1.querySelector('th');
    th.innerText = installments;
    th.style.visibility = 'visible';

    const td = paymentSchemeRow1.querySelectorAll('td');
    td[0].style.visibility = 'visible';
    td[1].innerText = price / installments;
    td[1].style.visibility = 'visible';
  });

  installmentAmountInput.addEventListener('keyup', e => {
    const price = parseFloat(priceInput.value);
    const installmentAmount = parseFloat(installmentAmountInput.value);
    const installmentsQuantity = installmentAmount;

    //if(Number.isInteger(installmentsQuantity)) {
    //  i.innerText = installmentsQuantity;
    //  iAmount.innerText = installmentAmount;
    //} else {
    //  i.innerText = Math.trunc(installmentsQuantity) - 1;
    //  iAmount.innerText = installmentAmount;
    //  restAmount.innerText = price - ((Math.trunc(installmentsQuantity) - 1) * installmentAmount);
    //}
  });
</script>
{% endblock %}